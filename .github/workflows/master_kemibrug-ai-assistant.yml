name: Build and deploy dotnet core app to Azure Function App - kemibrug-ai-assistant

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.'
  DOTNET_VERSION: '8.0.x'
  BRANCH: 'master'   # <-- ret til 'main' hvis det er jeres branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Ensure curl/jq/python available
        shell: bash
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y jq python3 >/dev/null

      # --- Byg docs.json fra ADO: de 4 README.md ---
      - name: Build docs.json from ADO READMEs
        shell: bash
        env:
          ORG_URL:    ${{ secrets.AZURE_DEVOPS_ORG_URL }}       # fx https://dev.azure.com/Custom-Web-Solutions
          PROJECT:    ${{ secrets.AZUREDEVOPSPROJECT }}         # projektnavn præcist som i ADO
          REPO:       ${{ secrets.AZUREDEVOPSREPOSITORYNAME }}  # repo-navn eller GUID (begge virker)
          PAT:        ${{ secrets.AZURE_DEVOPS_PAT }}
          BRANCH:     ${{ env.BRANCH }}
        run: |
          set -euo pipefail

          if [ -z "${ORG_URL:-}" ] || [ -z "${PROJECT:-}" ] || [ -z "${REPO:-}" ] || [ -z "${PAT:-}" ]; then
            echo "ERROR: Missing one of ORG_URL/PROJECT/REPO/PAT envs." >&2
            exit 2
          fi

          urlencode() {
            python3 - <<'PY'
            import sys, urllib.parse
            print(urllib.parse.quote(sys.stdin.read().strip(), safe=""))
            PY
          }

          fetch_file_b64 () {
            local path="$1"
            local enc_path; enc_path=$(printf "%s" "$path" | urlencode)
            # Items API – raw download + branch låsning
            local url="${ORG_URL%/}/${PROJECT}/_apis/git/repositories/${REPO}/items?path=${enc_path}&download=true&versionDescriptor.version=${BRANCH}&api-version=7.1-preview.1"
            echo "GET $url"
            # hent til tmp, læs http-kode
            local tmp http
            tmp=$(mktemp)
            http=$(curl -sS -L -u :$PAT -w "%{http_code}" -o "$tmp" "$url" || true)
            echo "HTTP $http for $path"
            if [ "$http" != "200" ]; then
              echo "WARN: $path not found (HTTP $http)"; rm -f "$tmp"; return 1
            fi
            # base64-enkod (uden linjeskift)
            local b64
            b64=$(base64 -w0 < "$tmp")
            rm -f "$tmp"
            printf "%s" "$b64"
            return 0
          }

          # De præcise README-stier (du sagde de hedder README.md alle steder)
          declare -A FILES
          FILES["/src/KemibrugV2.Application/README.md"]="Application"
          FILES["/src/KemibrugV2.Core/README.md"]="Core"
          FILES["/src/KemibrugV2.Infrastructure/README.md"]="Infrastructure"
          FILES["/src/KemibrugV2.WebApiServer/README.md"]="WebApiServer"

          echo "[" > docs.json
          first=1
          added=0

          for p in "${!FILES[@]}"; do
            layer="${FILES[$p]}"
            if b64=$(fetch_file_b64 "$p"); then
              id=$(echo "$p" | sed 's/[^a-zA-Z0-9._-]/_/g')
              entry=$(jq -n \
                --arg id "$id" \
                --arg path "$p" \
                --arg layer "$layer" \
                --arg project "KemibrugV2" \
                --arg content_b64 "$b64" \
                '{ "@search.action":"mergeOrUpload",
                   "id":$id, "path":$path, "layer":$layer, "project":$project,
                   "encoding":"base64", "content_b64":$content_b64 }')
              if [ $first -eq 0 ]; then echo "," >> docs.json; fi
              echo "$entry" >> docs.json
              first=0
              added=$((added+1))
              echo "OK: added $p ($layer)"
            else
              echo "SKIP: $p"
            fi
          done

          echo "]" >> docs.json

          if [ "$added" -eq 0 ]; then
            echo "ERROR: docs.json has no items. Check branch, repo, or paths." >&2
            exit 2
          fi

          echo "Built docs.json with $added item(s)."

      - name: Upload docs.json artifact (debug)
        uses: actions/upload-artifact@v4
        with:
          name: docs-json
          path: docs.json

      # --- Push til Azure AI Search ---
      - name: Push docs to Azure AI Search
        if: ${{ always() }}
        shell: bash
        env:
          SEARCH_ENDPOINT: ${{ secrets.AZURE_SEARCH_ENDPOINT }}   # https://<name>.search.windows.net
          SEARCH_INDEX:    ${{ secrets.AZURE_SEARCH_INDEX }}      # fx kemibrug-rules
          SEARCH_KEY:      ${{ secrets.AZURE_SEARCH_ADMIN_KEY }}
        run: |
          set -euo pipefail
          if [ ! -s docs.json ]; then
            echo "WARN: docs.json missing or empty; skipping AI Search push."
            exit 0
          fi
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "api-key: ${SEARCH_KEY}" \
            --data @docs.json \
            "${SEARCH_ENDPOINT%/}/indexes/${SEARCH_INDEX}/docs/index?api-version=2023-11-01"
          echo "Uploaded README docs to Azure AI Search."

      # --- Byg & deploy Function App ---
      - name: Build Functions
        shell: bash
        run: |
          set -e
          pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
          dotnet build --configuration Release --output ./output
          popd

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_CC61583FBBEC4600B796FAECBE66F119 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_4FAB11EB01304BE09563B7410BD1E837 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_BE4AA3B5668B4EFD94873CB496000E0A }}

      - name: Configure app settings
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az functionapp config appsettings set \
              --name kemibrug-ai-assistant \
              --resource-group rg-diplomprojekt-ai \
              --settings \
                AzureDevOpsPAT='${{ secrets.AZURE_DEVOPS_PAT }}' \
                AzureDevOpsOrgUrl='${{ secrets.AZURE_DEVOPS_ORG_URL }}' \
                AzureDevOpsProject='${{ secrets.AZUREDEVOPSPROJECT }}' \
                AzureDevOpsRepositoryName='${{ secrets.AZUREDEVOPSREPOSITORYNAME }}' \
                AzureOpenAIEndpoint='${{ secrets.AZURE_OPENAI_ENDPOINT }}' \
                AzureOpenAIApiKey='${{ secrets.AZURE_OPENAI_APIKEY }}' \
                AzureSearchEndpoint='${{ secrets.AZURE_SEARCH_ENDPOINT }}' \
                AzureSearchIndex='${{ secrets.AZURE_SEARCH_INDEX }}' \
                AzureSearchApiKey='${{ secrets.AZURE_SEARCH_ADMIN_KEY }}' \
                AnalysisSystemPromptV2='${{ secrets.ANALYSIS_SYSTEM_PROMPT_V2 }}'

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: 'kemibrug-ai-assistant'
          slot-name: 'Production'
          package: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/output'

